@page "/"
@using global::App.Services
@using Microsoft.Maui.Media
@inject AlprService AlprService

<div class="d-flex flex-column justify-content-center align-items-center p-3" style="min-height: 90vh;">
    
    <h1 class="mb-4 text-center fw-bold">ALPR Scanner</h1>

    <div class="card shadow-sm w-100" style="max-width: 500px;">
        <div class="card-body">
            <div class="d-grid gap-2 mb-4">
                <button class="btn btn-primary btn-lg py-3" @onclick="TakePhoto" disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <span>Processing...</span>
                    }
                    else
                    {
                        <span>Take Photo</span>
                    }
                </button>
        
                <button class="btn btn-outline-secondary btn-lg py-3" @onclick="PickPhoto" disabled="@_isLoading">
                     <span>Upload from Gallery</span>
                </button>
            </div>

            @if (!string.IsNullOrEmpty(_imgSrc))
            {
                <div class="text-center mb-3 bg-light p-2 rounded">
                    <img src="@_imgSrc" class="img-fluid rounded" style="max-height: 300px;" alt="Captured Image"/>
                </div>
            }

            @if (!string.IsNullOrEmpty(_resultText))
            {
                <div class="alert alert-success border-0 shadow-sm">
                    <h5 class="alert-heading fw-bold">Detected:</h5>
                    <pre class="mb-0" style="font-size: 1.2em; font-weight: bold; white-space: pre-wrap;">@_resultText</pre>
                </div>
            }
    
            @if (!string.IsNullOrEmpty(_errorText))
            {
                <div class="alert alert-danger d-flex align-items-center">
                    <span>@_errorText</span>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private string _imgSrc = "";
    private string _resultText = "";
    private string _errorText = "";
    private bool _isLoading;

    protected override async Task OnInitializedAsync()
    {
        if (!AlprService.IsInitialized)
        {
            _isLoading = true;
            try
            {
                await AlprService.InitializeAsync();
            }
            catch (Exception ex)
            {
                _errorText = $"Failed to load models: {ex.Message}";
            }
            finally
            {
                _isLoading = false;
            }
        }
    }

    private async Task TakePhoto()
    {
        try
        {
            if (MediaPicker.Default.IsCaptureSupported)
            {
                var photo = await MediaPicker.Default.CapturePhotoAsync();
                await ProcessPhoto(photo);
            }
            else
            {
                _errorText = "Camera is not supported on this device.";
            }
        }
        catch (Exception ex)
        {
            _errorText = $"Camera error: {ex.Message}";
        }
    }

    private async Task PickPhoto()
    {
        try
        {
            var photos = await MediaPicker.Default.PickPhotosAsync(new MediaPickerOptions
            {
                SelectionLimit = 1
            });
            await ProcessPhoto(photos.FirstOrDefault());
        }
        catch (Exception ex)
        {
            _errorText = $"Gallery error: {ex.Message}";
        }
    }

    private async Task ProcessPhoto(FileResult? photo)
    {
        if (photo == null) return;

        _errorText = "";
        _resultText = "";
        _isLoading = true;
        StateHasChanged();

        try
        {
            await using var stream = await photo.OpenReadAsync();
            
            var buffer = new byte[stream.Length];
            await stream.ReadExactlyAsync(buffer, 0, (int)stream.Length);
            var base64 = Convert.ToBase64String(buffer);
            _imgSrc = $"data:image/jpeg;base64,{base64}";

            stream.Position = 0; 
            _resultText = await Task.Run(() => AlprService.ProcessImage(stream));
        }
        catch (Exception ex)
        {
            _errorText = $"Processing error: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
}